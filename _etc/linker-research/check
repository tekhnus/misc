#!/usr/bin/env sh

if [[ "$(uname)" == "Linux" ]]; then
	showinfo() {
		ldd $1
	}
	withdebug() {
		LD_DEBUG=libs "$@"
	}
	SUFFIX=so
elif [[ "$(uname)" == "Darwin" ]]; then
	showinfo() {
		otool -L $1
		otool -l $1 | grep RC_RPATH
	}
	withdebug() {
		DYLD_PRINT_SEARCHING=1 "$@"
	}
	SUFFIX=dylib
fi

rm -rf dev

mkdir -p dev
mkdir -p dev/subdir
mkdir -p dev/bindir
mkdir -p dev/tmp

clang++ -o dev/libmylib.$SUFFIX -shared mylib.cpp
ln -s ../libmylib.$SUFFIX dev/subdir/libmylib-symlink.$SUFFIX

docheck() {
	showinfo $1
	withdebug $1
	(
		cd dev/tmp
		withdebug ../../$1
	)
}

echo "========= 1 ============="
clang++ -v -o dev/hello1 -L./dev -lmylib hello.cpp && docheck dev/hello1
echo "========= 2 ============="
clang++ -v -o dev/bindir/hello2 -L./dev -lmylib hello.cpp && docheck dev/bindir/hello2
echo "========= 3 ============="
clang++ -v -o dev/hello3 -L./dev/subdir -lmylib-symlink hello.cpp && docheck dev/hello3
echo "========= 4 ============="
clang++ -v -o dev/hello4 -L$PWD/dev -lmylib hello.cpp && docheck dev/hello4
echo "========= 5 ============="
clang++ -v -o dev/hello5 -L$PWD/dev -rpath ./dev -lmylib hello.cpp && docheck dev/hello5
echo "========= 6 ============="
clang++ -v -o dev/hello6 -L$PWD/dev -rpath '$ORIGIN' -lmylib hello.cpp && docheck dev/hello6
echo "========= 7 ============="
clang++ -v -o dev/hello7 -L$PWD/dev -rpath '@loader_path' -lmylib hello.cpp && \
	install_name_tool -change dev/libmylib.dylib @rpath/libmylib.dylib dev/hello7 && \
	docheck dev/hello7
