#!/bin/bash
chan=$1

echo "server will enter the loop" >>/tmp/crsh-log

{
	tput cup $(tput lines) 0 </dev/tty >/dev/tty 
	echo "server did enter the loop" >>/tmp/crsh-log
  status=0
	while true;
	do
		echo "$status"
	  echo 'server did send status' >>/tmp/crsh-log
		IFS= read -r cmd
	  echo "server did read a command $cmd" >>/tmp/crsh-log
		eval_cmd="${cmd##EVAL }"
		if [ ! "$eval_cmd" = "$cmd" ]; then
			echo </dev/tty >/dev/tty
			printf '\033[38;5;251m%.sâ”€\x1b[K\x1b[0m' $(seq 1 $(tput cols)) </dev/tty >/dev/tty
			echo "> $eval_cmd" </dev/tty >/dev/tty
		  echo "server will eval $eval_cmd" >>/tmp/crsh-log
			eval "$eval_cmd" </dev/tty >/dev/tty
			status="$?"
		else
			echo "unknown verb" >>/tmp/crsh-log
			break
		fi
	  echo 'server did eval' >>/tmp/crsh-log
		printf "\033[38;5;251m$(date '+(%H:%M)' | tr -d '\n') $(dirs +0)\x1b[K\x1b[0m" </dev/tty >/dev/tty
	done
} <$chan/command >$chan/result
