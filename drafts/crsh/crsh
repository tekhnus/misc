#!/bin/sh
mkdir -p darwin
mkdir -p linux

go build -o darwin/crsh-server cmd/server/main.go || exit
go build -o darwin/crsh-client cmd/client/main.go || exit
GOOS=linux GOARCH=amd64 go build -o linux/crsh-server cmd/server/main.go || exit
GOOS=linux GOARCH=amd64 go build -o linux/crsh-client cmd/client/main.go || exit

(
	cd darwin
	for file in *; do
		rm -f ~/.local/bin/$file || exit
		cp $file ~/.local/bin || exit
	done
)
cp crsh-server-in-abduco crsh-server-in-ssh ~/.local/bin || exit

ssh ma rm '/home/$USER/.local/bin/crsh*'
scp linux/* crsh-server-in-abduco crsh-server-in-ssh ma:/home/$USER/.local/bin

name="$1"
chan="/tmp/crsh-${name}.sock"

dir=$(CDPATH= cd -- "$(dirname -- "$0")" && pwd)
winid=$(kitty @ launch --title "crsh-server-${name}" --location=before --cwd=${dir} bash -c "kitty @ resize-window --self -a vertical -i +1000 2>/dev/null; ~/.local/bin/crsh-server-in-abduco $chan $name")

echo "Checking server availability" | nc localhost 5678
while true; do
	# res=$(echo HELLO | nc -U "$chan")
	# echo "Sent HELLO, got '$res'" | nc localhost 5678
	# if [ "$res" = "HELLO" ]; then
	# 	break
	# fi
	if [ -e "$chan" ]; then
		break
	fi
	sleep 2
done
echo "Server is ready" | nc localhost 5678

~/.local/bin/crsh-client "$chan" "$@"
kitty @ send-text --match "title:crsh-server-${name}" '\c\'

