#!/bin/bash
echo '' >>/tmp/crsh-log
echo 'STARTING NEW SESSION' >>/tmp/crsh-log
echo '' >>/tmp/crsh-log

if [ ! -p /tmp/crsh-command ]; then
  echo "command pipe not found" >/dev/stderr
  exit 1
fi

echo "master will enter the loop" >>/tmp/crsh-log
while true; do
  echo "master will read a line" >>/tmp/crsh-log
  kitty @ focus-window
  $(./third-party/linenoise-master/linenoise_main /tmp/linenoise-result </dev/tty >/dev/tty)
  line=$(cat /tmp/linenoise-result)
  echo "master did read a line $line" >>/tmp/crsh-log
  clear >/dev/tty </dev/tty
  kitty @ focus-window -m "cmdline:.*crsh-.*"
  echo "$line"
  echo "master did send the line" >>/tmp/crsh-log
  IFS= read -r res
  echo "master did read the result $res" >>/tmp/crsh-log
done >/tmp/crsh-command </tmp/crsh-result 
