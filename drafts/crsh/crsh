#!/bin/sh
go build -o crsh-server cmd/server/main.go || exit
go build -o crsh-client cmd/client/main.go || exit

for file in crsh-server crsh-client crsh-server-in-abduco; do
	rm -f ~/.local/bin/$file || exit
	cp $file ~/.local/bin || exit
done

name="$1"
chan="/tmp/crsh-${name}.sock"

dir=$(CDPATH= cd -- "$(dirname -- "$0")" && pwd)
winid=$(kitty @ launch --title crsh-server --location=before --cwd=${dir} bash -c "~/.local/bin/crsh-server-in-abduco $chan $name; if [ ! $? -eq 0 ]; then sleep 3; fi; sleep 1;")
kitty @ resize-window --self -a vertical -i -1000 2>/dev/null

sleep 1

~/.local/bin/crsh-client "$chan" "$@"
kitty @ send-text --match "title:crsh-server" '\c\'
