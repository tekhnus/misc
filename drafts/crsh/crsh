#!/bin/bash
set -m

rm -rf /tmp/crsh-log
touch /tmp/crsh-log

rm -rf /tmp/crsh-pids
mkfifo /tmp/crsh-pids

rm -rf /tmp/crsh-command
mkfifo /tmp/crsh-command

rm -rf /tmp/crsh-result
mkfifo /tmp/crsh-result

function get_pid() {
  exec sh -c 'echo "$PPID"'
}

(
  echo "$(get_pid)" >/tmp/crsh-pids
  echo 'client did send pid' >>/tmp/crsh-log
  while true; do
    echo 'client will read' >>/tmp/crsh-log
    read -p '> ' -r line >/dev/tty
    echo 'client did read' >>/tmp/crsh-log
    echo "$line"
    if [ -z "$line" ]; then
      exit
    fi
    echo 'client will sleep' >>/tmp/crsh-log
    kill -STOP -- "$(get_pid)"
    echo 'client did sleep' >>/tmp/crsh-log
  done >/tmp/crsh-command
)&

IFS= read -r reader_pid </tmp/crsh-pids

(
  echo "$(get_pid)" >/tmp/crsh-pids
  echo 'server did send pid' >>/tmp/crsh-log
  ./crsh-remote
)&

IFS= read -r server_pid </tmp/crsh-pids

echo 'master did recieve server pid' >>/tmp/crsh-log

(
  while true; do
    IFS= read -r res
    if [ -z "$res" ]; then
      echo 'master did finish server result' >>/tmp/crsh-log
      exit
    fi
    echo "master did recieve server result x${res}x" >>/tmp/crsh-log
    kill -STOP -- "-$server_pid" 2>/dev/null || break
  done </tmp/crsh-result
)&
disown

function on_sigchld () {
  if {
    kill -0 $reader_pid 2>/dev/null &&
    kill -0 $server_pid 2>/dev/null
  }; then
    return
  fi
  echo 'master will exit' >>/tmp/crsh-log
  exit
}

trap on_sigchld SIGCHLD

echo 'master will switch to client' >>/tmp/crsh-log
fg %1 >/dev/null
echo 'master did switch to client' >>/tmp/crsh-log
while true; do
  echo 'master did swap' >>/tmp/crsh-log
  fg %- >/dev/null
done
