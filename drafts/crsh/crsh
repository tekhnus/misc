#!/bin/bash
set -m

function get_pid() {
  exec sh -c 'echo "$PPID"'
}

rm -rf /tmp/crsh-pids
mkfifo /tmp/crsh-pids

rm -rf /tmp/crsh-command
mkfifo /tmp/crsh-command

rm -rf /tmp/crsh-result
mkfifo /tmp/crsh-result

(
  echo "$(get_pid)" >/tmp/crsh-pids
  while true; do
    read -p '> ' -r line >/dev/tty
    echo "$line"
    if [ -z "$line" ]; then
      exit
    fi
    kill -STOP -- "$(get_pid)"
  done >/tmp/crsh-command
)&

IFS= read -r reader_pid </tmp/crsh-pids

(
  echo "$(get_pid)" >/tmp/crsh-pids
  ./crsh-server
)&

IFS= read -r server_pid </tmp/crsh-pids

(
  while true; do
    read -r res
    kill -STOP -- "-$server_pid" 2>/dev/null || break
  done </tmp/crsh-result
)&
disown

function on_sigchld () {
  if {
    kill -0 $reader_pid 2>/dev/null &&
    kill -0 $server_pid 2>/dev/null
  }; then
    return
  fi
  exit
}

trap on_sigchld SIGCHLD

fg %1 >/dev/null
while true; do
  fg %- >/dev/null
done
