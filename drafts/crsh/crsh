#!/bin/bash
set -m

function get_pid() {
  exec sh -c 'echo "$PPID"'
}

( while true; do read -p '> ' -r line; echo "$line" >/tmp/crsh-command; if [ -z "$line" ]; then exit; fi; kill -STOP $(get_pid); done )
( ./crsh-server "$(get_pid)" ) 

function on_sigchld () {
  { kill -0 $(cat /tmp/crsh-reader-pid) && kill -0 $(cat /tmp/crsh-server-pid); } || exit
}

# trap on_sigchld SIGCHLD

while true; do
  fg %- >/dev/null
done
